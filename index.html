<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Homework Tracker</title>
    <!-- Load Inter font for clean look -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <!-- Load Font Awesome for icons (still needed for the Star) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- CUSTOM STYLES TO MATCH ORIGINAL DESIGN --- */
        :root {
            /* Color Palette from Image */
            --orange: #ff8c43;
            --purple: #6a1a8c;
            --light-bg: #fffbf5;
            --card-bg: white;
            --green: #48c48a;
            --red: #f16a6a;
            --yellow-star: #ffc400;
            --blue: #4299e1; /* New Blue for 'No Homework' */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .tracker-container {
            width: 100%;
            max-width: 900px;
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--purple);
            text-align: center;
            margin-bottom: 10px;
        }

        .stats-bar {
            display: flex;
            justify-content: space-around;
            background-color: #f7f3ed;
            padding: 12px;
            border-radius: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-label {
            font-size: 0.8rem;
            color: #6c757d;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--orange);
            margin-top: 4px;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }

        .day-card {
            background-color: #fff;
            padding: 12px 8px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            min-height: 120px; /* Ensure consistent height */
        }

        .day-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
        }

        .day-name {
            font-weight: 700;
            font-size: 0.85rem;
            color: var(--purple);
            margin-bottom: 5px;
        }

        .day-date {
            font-size: 1.5rem;
            font-weight: 900;
            color: var(--orange);
        }

        .status-badge {
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 6px;
            border-radius: 8px;
            margin-top: auto; /* Push to bottom */
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .status-badge.complete {
            background-color: var(--green);
            color: white;
        }

        .status-badge.incomplete {
            background-color: var(--red);
            color: white;
        }

        .status-badge.pending {
            background-color: var(--orange);
            color: white;
        }

        .status-badge.no-homework {
            background-color: var(--blue);
            color: white;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--card-bg);
            padding: 24px;
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.25rem;
            color: var(--purple);
            font-weight: 900;
        }

        .close-button {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #ccc;
            transition: color 0.2s;
        }

        .close-button:hover {
            color: var(--red);
        }

        .status-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .status-button {
            padding: 12px;
            border-radius: 10px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            text-align: left;
        }

        .status-button:active {
            transform: translateY(1px);
        }

        .status-button i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }

        .status-button.complete {
            background-color: var(--green);
            color: white;
        }
        .status-button.incomplete {
            background-color: var(--red);
            color: white;
        }
        .status-button.pending {
            background-color: var(--orange);
            color: white;
        }
        .status-button.no-homework {
            background-color: var(--blue);
            color: white;
        }

        .status-button.complete:hover { background-color: #3aa576; }
        .status-button.incomplete:hover { background-color: #d85c5c; }
        .status-button.pending:hover { background-color: #e57e3c; }
        .status-button.no-homework:hover { background-color: #3b82f6; }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .calendar {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }
            .day-card {
                min-height: 100px;
            }
            .day-date {
                font-size: 1.25rem;
            }
            .stats-bar {
                flex-direction: column;
                gap: 10px;
            }
            .stat-value {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div class="tracker-container">
        <h1>Weekly Homework Tracker</h1>
        
        <div class="stats-bar" id="statsBar">
            <div class="stat-item">
                <div class="stat-value" id="completeCount">0</div>
                <div class="stat-label">Complete</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="incompleteCount">0</div>
                <div class="stat-label">Incomplete</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="pendingCount">0</div>
                <div class="stat-label">Pending</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="noHomeworkCount">0</div>
                <div class="stat-label">No Homework</div>
            </div>
        </div>

        <div class="calendar" id="calendar">
            <!-- Day cards will be injected here by JavaScript -->
        </div>
        
        <p style="text-align: center; font-size: 0.75rem; color: #888; margin-top: 10px;">
            User ID: <span id="userIdDisplay">Loading...</span>
        </p>

    </div>

    <!-- Modal for status selection -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Set Status for [Day]</h2>
                <button class="close-button" onclick="closeModal()">&times;</button>
            </div>
            <div class="status-options">
                <button class="status-button complete" data-status="complete" onclick="saveStatus('complete')">
                    <i class="fas fa-check-circle"></i> Complete
                </button>
                <button class="status-button incomplete" data-status="incomplete" onclick="saveStatus('incomplete')">
                    <i class="fas fa-times-circle"></i> Incomplete
                </button>
                <button class="status-button pending" data-status="pending" onclick="saveStatus('pending')">
                    <i class="fas fa-hourglass-half"></i> Pending
                </button>
                <button class="status-button no-homework" data-status="no-homework" onclick="saveStatus('no-homework')">
                    <i class="fas fa-book-open"></i> No Homework
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        let db;
        let auth;
        let trackerRef;
        let isFirebaseReady = false;

        // Data Structure
        const dayNames = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        let dayStatus = {}; // Stores { dayKey: status }
        let selectedDayKey = null; // Key of the day being modified

        // --- UTILITY FUNCTIONS ---

        /**
         * Generates the day key (YYYY-MM-DD) for a given date.
         * @param {Date} date - The date object.
         * @returns {string} The formatted date string.
         */
        function getDayKey(date) {
            return date.toISOString().split('T')[0];
        }

        // --- UI RENDERING ---

        /**
         * Renders the calendar for the current week.
         */
        function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarEl.innerHTML = ''; // Clear previous days

            // Get the current date
            const now = new Date();
            // Find the start of the week (Monday)
            const dayOfWeek = now.getDay(); // 0 = Sunday, 1 = Monday, ..., 6 = Saturday
            const diff = now.getDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1); // Adjust for Monday start
            const monday = new Date(now.setDate(diff));

            for (let i = 0; i < 7; i++) {
                const day = new Date(monday);
                day.setDate(monday.getDate() + i);

                const dayKey = getDayKey(day);
                const status = dayStatus[dayKey] || 'pending'; // Default to pending if not set
                
                const card = document.createElement('div');
                card.className = 'day-card';
                card.setAttribute('data-day-key', dayKey);
                card.onclick = () => openModal(dayKey, dayNames[i]);

                card.innerHTML = `
                    <div class="day-name">${dayNames[i]}</div>
                    <div class="day-date">${day.getDate()}</div>
                    <div class="status-badge ${status}">${formatStatus(status)}</div>
                `;
                calendarEl.appendChild(card);
            }
        }

        /**
         * Converts status key to display text.
         * @param {string} statusKey 
         * @returns {string} 
         */
        function formatStatus(statusKey) {
            switch (statusKey) {
                case 'complete': return 'Complete';
                case 'incomplete': return 'Incomplete';
                case 'no-homework': return 'No Homework';
                case 'pending':
                default: return 'Pending';
            }
        }

        /**
         * Updates the status counts in the stats bar.
         */
        function updateStats() {
            const counts = { complete: 0, incomplete: 0, pending: 0, 'no-homework': 0 };

            Object.values(dayStatus).forEach(status => {
                if (counts.hasOwnProperty(status)) {
                    counts[status]++;
                } else {
                    counts.pending++; // Catch any undefined status as pending
                }
            });

            // Ensure we count the default 'pending' days for the current week
            const totalDaysInWeek = 7;
            const daysTracked = Object.keys(dayStatus).length;
            counts.pending += Math.max(0, totalDaysInWeek - daysTracked); // Add missing days as pending

            document.getElementById('completeCount').textContent = counts.complete;
            document.getElementById('incompleteCount').textContent = counts.incomplete;
            document.getElementById('pendingCount').textContent = counts.pending;
            document.getElementById('noHomeworkCount').textContent = counts['no-homework'];
        }

        // --- MODAL & INTERACTION ---

        /**
         * Opens the modal to select a status for a day.
         * @param {string} dayKey - The YYYY-MM-DD key.
         * @param {string} dayName - The name of the day (e.g., Mon, Tue).
         */
        function openModal(dayKey, dayName) {
            selectedDayKey = dayKey;
            document.getElementById('modalTitle').textContent = `Set Status for ${dayName}`;
            document.getElementById('statusModal').classList.add('active');
        }

        /**
         * Closes the modal.
         */
        function closeModal() {
            document.getElementById('statusModal').classList.remove('active');
            selectedDayKey = null;
        }

        /**
         * Saves the selected status and updates Firestore.
         * @param {string} status - The selected status ('complete', 'incomplete', 'pending', 'no-homework').
         */
        async function saveStatus(status) {
            if (!selectedDayKey) return;

            // 1. Update local state
            dayStatus[selectedDayKey] = status;
            
            // 2. Update UI
            const card = document.querySelector(`.day-card[data-day-key="${selectedDayKey}"]`);
            if (card) {
                const badge = card.querySelector('.status-badge');
                badge.className = `status-badge ${status}`;
                badge.textContent = formatStatus(status);
            }
            updateStats();
            
            // 3. Persist to Firestore
            if (isFirebaseReady && trackerRef) {
                try {
                    // Use setDoc to replace the entire document content
                    await setDoc(trackerRef, { dayStatus: dayStatus });
                } catch (error) {
                    console.error("Error writing document: ", error);
                }
            } else {
                console.warn("Firebase not ready. Data saved locally only.");
            }

            closeModal();
        }

        // --- FIREBASE AND DATA PERSISTENCE ---

        /**
         * Sets up the real-time listener for the tracker data.
         */
        function loadData() {
            if (!isFirebaseReady || !trackerRef) {
                console.error("Attempted to load data before Firebase was ready.");
                return;
            }

            // Real-time listener using onSnapshot
            onSnapshot(trackerRef, (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    // Deserialize the data
                    dayStatus = data.dayStatus || {};
                    console.log("Data loaded from Firestore:", dayStatus);
                } else {
                    console.log("No tracker data found. Starting fresh.");
                    dayStatus = {};
                }

                // Always re-render and update stats after data is received
                renderCalendar();
                updateStats();
            }, (error) => {
                console.error("Error listening to data:", error);
                // If there's a permission error, warn the user and update UI with current local data
                // This usually means the security rules are incorrect or the user is not authenticated.
                renderCalendar();
                updateStats();
            });
        }

        /**
         * Initializes Firebase, authenticates, and starts loading data.
         */
        async function authenticateAndStart() {
            try {
                // 1. Initialize Firebase services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('Debug');
                
                // 2. Authentication
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Get the user ID immediately after authentication
                const userId = auth.currentUser?.uid || 'anonymous';
                document.getElementById('userIdDisplay').textContent = userId;

                // *** CRITICAL FIX: Changed path to use PRIVATE, user-specific data path ***
                // Data is now stored at: artifacts/{appId}/users/{userId}/tracker_data/weeks
                trackerRef = doc(db, `artifacts/${appId}/users/${userId}/tracker_data/weeks`);
                isFirebaseReady = true;

                // 3. Load persistent data
                loadData(); 

            } catch (error) {
                console.error("CRITICAL FIREBASE ERROR: Data persistence is disabled. The application will function locally, but data will not be saved. Error:", error.message);
                // Since the calendar is already rendered, we just update stats with default data.
                isFirebaseReady = false;
                renderCalendar();
                updateStats();
            }
        }
        
        authenticateAndStart();

    </script>
</body>
</html>
